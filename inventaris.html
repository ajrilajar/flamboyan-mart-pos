<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventaris - Flamboyan Mart</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        :root { 
            --green: #27ae60; 
            --bg: #f8f9fa; 
            --gray: #868e96; 
            --white: #fff; 
            --border: #eee; 
            --red: #e74c3c; 
            --blue-soft: #e7f5ff; 
            --blue-text: #1971c2;
            --text: #333;
        }
        
        body { 
            margin: 0; 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            overflow-x: hidden; 
            -webkit-tap-highlight-color: transparent;
        }
        
        .page { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            width: 100%; 
            background: var(--bg); 
            position: fixed; 
            top: 0; 
            left: 0; 
            z-index: 10; 
            padding-top: 0; 
        }
        
        .hidden { display: none !important; }
        
        .search-area { 
            background: var(--white); 
            padding: 10px 15px; 
            display: flex; 
            gap: 10px; 
            border-bottom: 1px solid var(--border); 
            align-items: center; 
        }
        
        .search-wrap { 
            position: relative; 
            flex: 1; 
        }
        
        .search-wrap span { 
            position: absolute; 
            left: 10px; 
            top: 11px; 
            color: var(--gray); 
            font-size: 20px; 
        }
        
        .search-wrap input { 
            width: 100%; 
            height: 42px; 
            padding: 0 10px 0 38px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            box-sizing: border-box; 
            outline: none; 
            background: #fafafa; 
        }
        
        .icon-btn-box { 
            height: 42px; 
            width: 45px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background: white; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            gap: 2px; 
            transition: 0.3s; 
            flex-shrink: 0; 
        }
        
        .icon-btn-box:active { background: #f0f0f0; }
        
        .switch-mini { 
            position: relative; 
            width: 26px; 
            height: 12px; 
        }
        
        .switch-mini input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        }
        
        .slider-mini { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: #ccc; 
            transition: .4s; 
            border-radius: 12px; 
        }
        
        .slider-mini:before { 
            position: absolute; 
            content: ""; 
            height: 8px; 
            width: 8px; 
            left: 2px; 
            bottom: 2px; 
            background-color: white; 
            transition: .4s; 
            border-radius: 50%; 
        }
        
        input:checked + .slider-mini { background-color: var(--green); }
        input:checked + .slider-mini:before { transform: translateX(14px); }
        
        .fab { 
            position: fixed; 
            right: 20px; 
            bottom: 115px;
            width: 56px; 
            height: 56px; 
            background-color: var(--green); 
            border-radius: 16px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            box-shadow: 0 6px 16px rgba(39, 174, 96, 0.4); 
            cursor: pointer; 
            z-index: 100; 
            transition: all 0.3s ease; 
        }
        
        .fab:active { 
            transform: scale(0.92); 
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3); 
        }
        
        @media (max-width: 767px) {
            .fab {
                right: 20px;
                bottom: 120px;
            }
        }
        
        @media (min-width: 768px) and (max-width: 1023px) {
            .fab {
                left: 90%;
                transform: translateX(-50%);
                right: auto;
                bottom: 100px;
            }
        }
        
        @media (min-width: 1024px) {
            .fab {
                left: 90%;
                transform: translateX(-50%);
                right: auto;
                bottom: 110px;
                width: 60px;
                height: 60px;
                border-radius: 18px;
            }
        }
        
        .inventory-list { 
            padding: 10px; 
            padding-bottom: 80px; 
            overflow-y: auto; 
            flex: 1; 
        }
        
        .card { 
            background: var(--white); 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 10px; 
            display: flex; 
            align-items: center; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
        }
        
        .initial { 
            width: 45px; 
            height: 45px; 
            background: #f1f3f5; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 700; 
            margin-right: 12px; 
        }
        
        .info { flex: 1; }
        
        .price-row { 
            display: flex; 
            gap: 15px; 
            font-size: 10px; 
            color: var(--gray); 
            margin-top: 4px; 
        }
        
        .price-row strong { 
            display: block; 
            color: #333; 
            font-size: 12px; 
        }
        
        .status { text-align: right; }
        
        .badge { 
            background: #eceff1; 
            color: #546e7a; 
            font-size: 9px; 
            padding: 2px 8px; 
            border-radius: 4px; 
        }
        
        .settings-content { 
            background: var(--white); 
            flex: 1; 
            overflow-y: auto; 
            padding-bottom: 20px; 
        }
        
        .section-title { 
            padding: 15px 20px; 
            font-size: 13px; 
            color: var(--gray); 
            font-weight: 600; 
            background: var(--bg); 
            text-transform: uppercase; 
        }
        
        .menu-item { 
            padding: 15px 20px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            cursor: pointer; 
        }
        
        .menu-left { 
            display: flex; 
            align-items: center; 
            flex: 1; 
        }
        
        .menu-text { margin-left: 15px; }
        
        .menu-text .title { 
            font-size: 14px; 
            font-weight: 500; 
        }
        
        .menu-text .sub { 
            font-size: 11px; 
            color: var(--gray); 
            margin-top: 2px; 
        }
        
        .switch { 
            position: relative; 
            width: 40px; 
            height: 20px; 
        }
        
        .switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        }
        
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: #ccc; 
            transition: .4s; 
            border-radius: 20px; 
        }
        
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 16px; 
            width: 16px; 
            left: 2px; 
            bottom: 2px; 
            background-color: white; 
            transition: .4s; 
            border-radius: 50%; 
        }
        
        input:checked + .slider { background-color: var(--green); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .stepper { 
            display: flex; 
            align-items: center; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            overflow: hidden; 
            height: 36px; 
            background: white; 
            width: fit-content; 
            min-width: 100px; 
        }
        
        .step-btn { 
            background: #f8f9fa; 
            border: none; 
            width: 35px; 
            height: 100%; 
            color: var(--green); 
            font-weight: bold; 
            font-size: 20px; 
            cursor: pointer; 
            flex-shrink: 0; 
        }
        
        .step-input { 
            width: 30px; 
            flex-grow: 1; 
            border: none; 
            text-align: center; 
            font-size: 14px; 
            font-weight: 700; 
            outline: none; 
            background: transparent; 
            appearance: textfield; 
            -moz-appearance: textfield; 
        }
        
        .step-input::-webkit-inner-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        
        .common-list-item { 
            padding: 15px 20px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: white; 
        }
        
        .bottom-btn-container { 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            padding: 15px 20px; 
            background: var(--bg); 
            box-sizing: border-box; 
            z-index: 110; 
            border-top: 1px solid rgba(0,0,0,0.02); 
        }
        
        .btn-full { 
            background: var(--green); 
            color: white; 
            border: none; 
            width: 100%; 
            padding: 14px; 
            border-radius: 8px; 
            font-weight: 600; 
            font-size: 15px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
        }
        
        .btn-full:disabled { 
            background: #f0f0f0; 
            color: #ccc; 
            cursor: not-allowed; 
        }
        
        .form-container { 
            padding: 20px; 
            background: white; 
            flex: 1; 
        }
        
        .input-box { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            box-sizing: border-box; 
            outline: none; 
            font-size: 14px; 
            margin-top: 5px; 
        }
        
        .standard-header { 
            background: var(--white); 
            padding: 0 20px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            position: relative;
            z-index: 100;
            height: 60px;
            min-height: 60px;
            box-sizing: border-box;
        }
        
        .standard-header h2 { 
            margin: 0; 
            font-size: 17px; 
            font-weight: 600; 
            margin-left: 15px; 
            flex: 1;
        }
        
        .back-button {
            display: flex;
            align-items: center;
            cursor: pointer;
            color: var(--text);
        }

        .content { 
            padding: 20px; 
            background: white; 
            flex: 1; 
            overflow-y: auto; 
            padding-bottom: 80px; 
        }

        .input-group { 
            position: relative; 
            margin-bottom: 12px;
        }
        
        .input-box-v6 { 
            width: 100%; 
            height: 52px; 
            padding: 0 15px;
            border: 1px solid #ddd; 
            border-radius: 8px; 
            box-sizing: border-box; 
            outline: none; 
            font-size: 15px; 
            background: #fff; 
            transition: border-color 0.2s;
            display: flex;
            align-items: center;
        }

        .floating-label {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 15px;
            transition: all 0.2s ease;
            pointer-events: none;
            background: white;
            padding: 0 4px;
            margin: 0;
        }

        .input-box-v6:focus + .floating-label,
        .input-box-v6:not(:placeholder-shown) + .floating-label {
            top: -10px;
            left: 10px;
            font-size: 12px;
            font-weight: 600;
            color: var(--green);
            transform: none;
        }

        .input-box-v6:focus { 
            border-color: var(--green); 
            border-width: 1.5px; 
        }

        .input-box-v6::placeholder {
            color: transparent;
        }

        .select-wrapper { 
            position: relative; 
            cursor: pointer; 
        }
        
        .select-wrapper .input-box-v6 {
            padding-right: 40px;
            cursor: pointer;
        }
        
        .select-wrapper .chevron { 
            position: absolute; 
            right: 15px; 
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray); 
            font-size: 20px; 
        }

        .tabs { 
            display: flex; 
            border-bottom: 2px solid #eee; 
            margin: 15px 0 15px 0;
        }
        
        .tab { 
            flex: 1; 
            text-align: center; 
            padding-bottom: 10px; 
            font-size: 14px; 
            font-weight: 600; 
            color: var(--gray); 
            cursor: pointer; 
        }
        
        .tab.active { 
            color: var(--green); 
            border-bottom: 2px solid var(--green); 
            margin-bottom: -2px; 
        }

        .grid-2 { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px;
        }

        .switch-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px 0;
            border-top: 1px solid var(--border); 
            margin-top: 15px;
        }
        
        .switch-label { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 14px; 
            font-weight: 500; 
        }

        .pilih-panel { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: var(--white); 
            z-index: 1000; 
            display: none; 
            flex-direction: column; 
        }
        
        .pilih-panel.show { display: flex; }
        
        .pilih-panel .search-area { 
            background: var(--white); 
            padding: 10px 15px; 
            border-bottom: 1px solid var(--border); 
        }
        
        .list-container { 
            flex: 1; 
            overflow-y: auto; 
            background: white; 
            padding-bottom: 80px;
        }
        
        .list-item { 
            padding: 12px 20px;
            border-bottom: 1px solid var(--border); 
            cursor: pointer; 
            transition: background 0.2s; 
            min-height: 44px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .list-item:hover { background: #f9f9f9; }
        
        .list-item .name { 
            font-weight: 500; 
            font-size: 15px; 
        }
        
        .list-item .subtitle { 
            font-size: 12px; 
            color: var(--gray); 
            margin-top: 2px; 
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .modal-overlay.show { display: block; }

        .form-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--white);
            z-index: 1001;
            display: none;
            flex-direction: column;
        }
        
        .form-modal.show { display: flex; }
        
        .form-content {
            padding: 20px;
            flex: 1;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box; 
            outline: none; 
            font-size: 14px; 
            margin-top: 5px; 
        }
        
        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--green); 
            display: block;
            margin-bottom: 5px;
        }

        .info-text {
            color: var(--gray);
            font-size: 12px;
            margin-top: 4px;
            display: flex;
            align-items: flex-start;
            gap: 5px;
        }
        
        .info-text .material-icons-outlined {
            font-size: 14px;
            margin-top: 1px;
        }

        .section-title-v6 { 
            font-size: 13px; 
            font-weight: 700; 
            color: #555; 
            margin-bottom: 8px;
            letter-spacing: 0.5px; 
            text-transform: uppercase; 
        }
        
        .section-divider { 
            border: 0; 
            border-top: 1px solid #f0f0f0; 
            margin: 15px 0;
        }

        .conversion-list { 
            display: flex; 
            flex-direction: column; 
            gap: 8px;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            padding-right: 5px;
            margin-top: 8px;
        }

        .conversion-list::-webkit-scrollbar {
            width: 4px;
        }
        
        .conversion-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .conversion-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .conversion-list::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .compact-conversion-row {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 8px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
            flex-shrink: 0;
        }

        .row-left { 
            display: flex; 
            align-items: center; 
            gap: 6px;
            flex: 1; 
            min-width: 0;
        }
        
        .static-num { 
            color: var(--gray); 
            font-weight: 500; 
            font-size: 14px; 
            flex-shrink: 0;
        }

        .clickable-unit {
            display: flex; 
            align-items: center; 
            gap: 4px;
            background: var(--blue-soft);
            padding: 5px 8px;
            border-radius: 6px;
            border: 1px dashed #a5d8ff;
            cursor: pointer; 
            transition: 0.2s;
            max-width: 110px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .clickable-unit:active { 
            transform: scale(0.95); 
            background: #d0ebff; 
        }
        
        .unit-code { 
            font-weight: 700; 
            color: var(--blue-text); 
            font-size: 13px;
        }
        
        .icon-edit { 
            font-size: 13px;
            color: var(--blue-text); 
            opacity: 0.6; 
            flex-shrink: 0;
        }

        .row-center { 
            display: flex; 
            align-items: center; 
            gap: 6px;
            flex-shrink: 0;
        }
        
        .compact-input-field {
            width: 60px;
            height: 36px;
            border: 1px solid #ddd; 
            border-radius: 6px;
            text-align: center; 
            font-weight: 700; 
            font-size: 15px;
            color: var(--text);
            outline: none; 
            padding: 0; 
            background: #fff;
            flex-shrink: 0;
        }
        
        .compact-input-field:focus { 
            border-color: var(--green); 
            background: #f0fdf4; 
        }
        
        .base-unit-code { 
            font-size: 13px;
            font-weight: 700; 
            color: var(--green); 
            flex-shrink: 0;
        }

        .btn-delete-compact {
            width: 30px;
            height: 30px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-radius: 6px; 
            color: var(--red); 
            cursor: pointer;
            margin-left: 4px;
            flex-shrink: 0;
        }
        
        .btn-delete-compact:active { 
            background: #ffebeb; 
        }

        .btn-add-unit {
            margin-top: 10px;
            border: 1px dashed #ccc;
            color: #666;
            background: #fafafa;
            padding: 12px;
            border-radius: 8px;
            text-align: center; 
            font-weight: 600; 
            font-size: 13px;
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 6px;
            flex-shrink: 0;
        }
        
        .btn-add-unit:active { 
            background: #eee; 
        }
        
        .btn-add-unit.green {
            border-color: var(--green);
            background: #f0fdf4;
            color: var(--green);
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: var(--gray);
            flex-shrink: 0;
        }
        
        .empty-state .material-icons-outlined {
            font-size: 40px;
            margin-bottom: 8px;
            opacity: 0.5;
        }
        
        .panel-content-scrollable {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 90px;
        }
        
        .list-container .empty-state {
            padding: 30px 15px;
        }

        .inventaris-header {
            background: var(--white);
            padding: 0 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            height: 60px;
            min-height: 60px;
            box-sizing: border-box;
        }
        
        .inventaris-header h2 {
            margin: 0;
            font-size: 17px;
            font-weight: 600;
            color: #333;
        }
        
        .header-settings {
            color: var(--green);
            font-size: 22px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
        }
        
        .header-settings:active {
            background: rgba(39, 174, 96, 0.1);
        }
        
        /* Utility untuk tab content */
        .tab-content-section {
            display: none;
            animation: fadeIn 0.2s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
/* --- CSS FINAL: PAKSA LAYOUT RAPI --- */

/* 1. Baris Pembungkus: Paksa Rata Atas */
.flex-row {
    display: flex !important;
    width: 100% !important;
    /* Menggunakan gap 10px */
    gap: 10px !important;
    align-items: flex-start !important;
    margin-bottom: 15px !important;
    box-sizing: border-box !important;
}

/* 80:20 (Harga Beli & Satuan) */
.w-80 { 
    flex: 0 0 calc(80% - 5px) !important; /* Kurangi setengah dari gap */
    max-width: calc(80% - 5px) !important;
}
.w-20 { 
    flex: 0 0 calc(20% - 5px) !important; /* Kurangi setengah dari gap */
    max-width: calc(20% - 5px) !important;
}

/* 30:70 (Min Qty & Harga Grosir) */
.w-30 { 
    flex: 0 0 calc(30% - 3px) !important; 
    max-width: calc(30% - 3px) !important;
}
.w-70 { 
    flex: 0 0 calc(70% - 7px) !important; 
    max-width: calc(70% - 7px) !important;
}

/* Pastikan input group tidak punya margin sisa yang mendorong ke kanan */
.flex-row .input-group {
    margin: 0 !important;
    width: 100% !important;
}

/* Sembunyikan simbol panah bawah di dropdown jika masih ada di CSS */
.select-trigger .material-icons-outlined {
    display: none !important;
}

/* 3. Container Dropdown: Paksa Tinggi & Reset Margin */
.custom-select-container {
    position: relative !important;
    height: 52px !important; /* Tinggi Wajib Sama dengan Input */
    margin: 0 !important;
    padding: 0 !important;
    box-sizing: border-box !important;
}

/* 4. Input Kiri: Paksa Tinggi & Reset Margin */
.flex-row .input-group {
    margin-bottom: 0 !important; /* Hapus margin bawah agar sejajar */
    height: 52px !important;
}

/* 5. Tombol Dropdown: Styling */
.select-trigger {
    width: 100% !important;
    height: 100% !important; /* Ikut tinggi container (52px) */
    background-color: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 8px !important; /* Padding kecil agar muat */
    cursor: pointer;
    box-sizing: border-box !important;
}

/* 6. Teks di dalam Tombol */
.select-trigger span {
    font-size: 13px !important;
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 7. List Dropdown: Agar tidak melebar */
.select-options {
    position: absolute;
    top: 105%;
    /* Ganti 'left: 0' menjadi 'right: 0' agar patokannya sisi kanan kotak 20% */
    right: 0 !important; 
    left: auto !important;
    
    /* Gunakan min-width agar jika nama sangat panjang, dia membentang ke KIRI */
    min-width: 150px !important; 
    width: auto !important; /* Biarkan lebar mengikuti konten */
    max-width: 250px !important; /* Batas maksimal agar tidak menutupi seluruh layar */
    
    background: white;
    border: 1px solid #eee;
    border-radius: 8px;
    box-shadow: -5px 5px 15px rgba(0,0,0,0.1); /* Shadow bergeser ke kiri */
    z-index: 1000;
    display: none;
    overflow: hidden;
}
.select-options.open { display: block; }

.select-option {
    padding: 12px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    font-size: 14px;
}
.select-option:hover { background: #f9f9f9; }

/* --- CSS MODAL KONFIRMASI (KHUSUS TAMBAH BARANG) --- */
.modal-confirm-overlay-tb {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 2000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal-confirm-card-tb {
    background: white;
    width: 100%;
    max-width: 320px;
    border-radius: 20px;
    padding: 25px 20px;
    text-align: center;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    animation: popUpTb 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes popUpTb {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.icon-circle-tb {
    width: 50px; height: 50px;
    background: #e8f5e9;
    color: var(--green);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 15px auto;
}

.modal-confirm-title-tb {
    font-size: 18px; font-weight: 700; color: #333;
    margin-bottom: 10px;
}

.modal-confirm-text-tb {
    font-size: 14px; color: #666; line-height: 1.5;
    margin-bottom: 25px;
}

.btn-continue-tb {
    background: var(--green);
    color: white;
    border: none;
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    margin-bottom: 15px;
}

.btn-discard-tb {
    background: transparent;
    border: none;
    color: #333;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    padding: 5px;
}

/* Gaya untuk teks satuan di dalam field */
.unit-indicator {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    font-weight: 700;
    color: var(--green);
    pointer-events: none; /* Agar tidak mengganggu klik input */
    opacity: 0; /* Sembunyi secara default */
    transition: opacity 0.2s;
    background: white;
    padding-left: 5px;
}

/* Munculkan saat input diisi atau difokuskan */
.input-box-v6:focus ~ .unit-indicator,
.input-box-v6:not(:placeholder-shown) ~ .unit-indicator {
    opacity: 1;
}

/* --- HAPUS TOMBOL PANAH TAMBAH/KURANG PADA INPUT NUMBER --- */

/* Untuk Chrome, Safari, Edge, dan Opera */
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* Untuk Firefox */
input[type=number] {
    -moz-appearance: textfield;
}
    </style>
</head>
<body>
    <div class="modal-overlay" id="modalOverlay"></div>

    <div id="page-inventaris" class="page">
        <div class="inventaris-header">
            <h2>Inventaris</h2>
            <span class="material-icons-outlined header-settings" onclick="bukaPengaturan()">settings</span>
        </div>
        
        <div class="search-area">
            <div class="search-wrap">
                <span class="material-icons-outlined">search</span>
                <input type="text" placeholder="Cari Barang...">
            </div>
            
            <div class="icon-btn-box" onclick="document.getElementById('market-chk').click()">
                <span class="material-icons-outlined" id="status-icon" style="font-size: 20px; color: var(--gray);">sensors</span>
                <div class="switch-mini"><input type="checkbox" id="market-chk" onchange="updateOnlineStatus(this)"><span class="slider-mini"></span></div>
            </div>
        </div>
        
        <div id="inventory-list" class="inventory-list"></div>
        <div class="fab" onclick="bukaTambahBarang()">
            <span class="material-icons-outlined" style="font-size: 24px;">add</span>
        </div>
    </div>

    <div id="page-pengaturan" class="page hidden">
        <div class="standard-header">
            <div class="back-button" onclick="goBack()">
                <span class="material-icons-outlined">arrow_back</span>
            </div>
            <h2>Pengaturan Barang</h2>
        </div>
        <div class="settings-content">
            <div class="section-title">Umum</div>
            <div class="menu-item" onclick="showPage('page-kategori')"><div class="menu-left"><span class="material-icons-outlined">category</span><div class="menu-text"><div class="title">Kelola Kategori Barang</div><div class="sub">Kategori membantu pengelompokan item efektif.</div></div></div><span class="material-icons-outlined" style="color:#ccc">chevron_right</span></div>
            <div class="menu-item" onclick="showPage('page-satuan')"><div class="menu-left"><span class="material-icons-outlined">straighten</span><div class="menu-text"><div class="title">Kelola Satuan Ukur</div><div class="sub">Atur satuan seperti Dus, PCS, atau Box.</div></div></div><span class="material-icons-outlined" style="color:#ccc">chevron_right</span></div>
            <div class="menu-item"><div class="menu-left"><span class="material-icons-outlined">image</span><div class="menu-text"><div class="title">Unggah Gambar Barang</div><div class="sub">Tampilkan visual produk di daftar.</div></div></div><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
            <div class="section-title">Manajemen Harga & Inventaris</div>
            <div class="menu-item" onclick="showPage('page-marketplace')"><div class="menu-left"><span class="material-icons-outlined">storefront</span><div class="menu-text"><div class="title">Marketplace</div><div class="sub">Integrasi data ke marketplace online.</div></div></div><span class="material-icons-outlined" style="color:#ccc">chevron_right</span></div>
            <div class="menu-item"><div class="menu-left"><span class="material-icons-outlined">payments</span><div class="menu-text"><div class="title">Biaya Marketplace</div><div class="sub">Hitung potongan biaya admin.</div></div></div><label class="switch"><input type="checkbox"><span class="slider"></span></label></div>
            <div class="menu-item" onclick="showPage('page-suplayer')"><div class="menu-left"><span class="material-icons-outlined">local_shipping</span><div class="menu-text"><div class="title">Suplayer</div><div class="sub">Manajemen harga khusus dari pemasok.</div></div></div><span class="material-icons-outlined" style="color:#ccc">chevron_right</span></div>
            <div class="menu-item"><div class="menu-left"><span class="material-icons-outlined">receipt</span><div class="menu-text"><div class="title">Harga Grosir</div><div class="sub">Aktifkan opsi harga grosir.</div></div></div><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
            <div class="menu-item"><div class="menu-left"><span class="material-icons-outlined">sell</span><div class="menu-text"><div class="title">Harga Eceran</div><div class="sub">Tampilkan harga jual satuan.</div></div></div><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
            <div class="menu-item"><div class="menu-left"><span class="material-icons-outlined">straighten</span><div class="menu-text"><div class="title">Satuan Default</div><div class="sub">Otomatis isi satuan saat tambah barang.</div></div></div><label class="switch"><input type="checkbox"><span class="slider"></span></label></div>
            <div class="menu-item"><div class="menu-left"><span class="material-icons-outlined">report_problem</span><div class="menu-text"><div class="title">Dialog Peringatan Stok Rendah</div><div class="sub">Notifikasi stok hampir habis.</div></div></div><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
            <div class="menu-item"><div class="menu-left"><span class="material-icons-outlined">pin</span><div class="menu-text"><div class="title">Jumlah (Angka Desimal)</div><div class="sub">Presisi digit belakang koma.</div></div></div><div class="stepper"><button class="step-btn" onclick="adjustDecimal(-1)">âˆ’</button><input type="number" id="decimal-count" class="step-input" value="0" readonly><button class="step-btn" onclick="adjustDecimal(1)">+</button></div></div>
        </div>
    </div>

    <div id="page-kategori" class="page hidden">
        <div class="standard-header">
            <div class="back-button" onclick="goBack()">
                <span class="material-icons-outlined">arrow_back</span>
            </div>
            <h2>Kelola Kategori</h2>
        </div>
        <div class="search-area"><div class="search-wrap"><span class="material-icons-outlined">search</span><input type="text" placeholder="Cari Kategori"></div></div>
        <div id="category-list-display" style="flex:1; overflow-y:auto; background:white; padding-bottom:80px;"></div>
        <div class="bottom-btn-container"><button class="btn-full" onclick="openAdd('cat')">+ Tambahkan Kategori Baru</button></div>
    </div>

    <div id="page-marketplace" class="page hidden">
        <div class="standard-header">
            <div class="back-button" onclick="goBack()">
                <span class="material-icons-outlined">arrow_back</span>
            </div>
            <h2>Kelola Marketplace</h2>
        </div>
        <div class="search-area"><div class="search-wrap"><span class="material-icons-outlined">search</span><input type="text" placeholder="Cari Marketplace"></div></div>
        <div id="market-list-display" style="flex:1; overflow-y:auto; background:white; padding-bottom:80px;"></div>
        <div class="bottom-btn-container"><button class="btn-full" onclick="openAdd('mkt')">+ Tambahkan Marketplace Baru</button></div>
    </div>

    <div id="page-suplayer" class="page hidden">
        <div class="standard-header">
            <div class="back-button" onclick="goBack()">
                <span class="material-icons-outlined">arrow_back</span>
            </div>
            <h2>Kelola Suplayer</h2>
        </div>
        <div class="search-area"><div class="search-wrap"><span class="material-icons-outlined">search</span><input type="text" placeholder="Cari Suplayer"></div></div>
        <div id="supplier-list-display" style="flex:1; overflow-y:auto; background:white; padding-bottom:80px;"></div>
        <div class="bottom-btn-container"><button class="btn-full" onclick="openAdd('sup')">+ Tambahkan Suplayer Baru</button></div>
    </div>

    <div id="page-form-crud" class="page hidden">
        <div class="standard-header">
            <div class="back-button" onclick="goBack()">
                <span class="material-icons-outlined">arrow_back</span>
            </div>
            <h2 id="crudFormTitle">Form</h2>
        </div>
        <div class="form-container"><div style="margin-bottom:20px;"><label id="crudLabel" style="font-size:13px; font-weight:600; color:var(--green)">Nama</label><input type="text" id="crudInput" class="input-box" style="border:1px solid var(--green)"></div></div>
        <div class="bottom-btn-container"><button id="crudSaveBtn" class="btn-full" disabled>Simpan</button></div>
    </div>

    <div id="page-satuan" class="page hidden">
        <div class="standard-header">
            <div class="back-button" onclick="goBack()">
                <span class="material-icons-outlined">arrow_back</span>
            </div>
            <h2>Kelola Satuan</h2>
        </div>
        <div class="search-area"><div class="search-wrap"><span class="material-icons-outlined">search</span><input type="text" placeholder="Cari Satuan"></div></div>
        <div id="unit-list-display" style="flex:1; overflow-y:auto; background:white; padding-bottom:80px;"></div>
        <div class="bottom-btn-container"><button class="btn-full" onclick="openAddUnit()">+ Tambahkan Satuan Baru</button></div>
    </div>

    <div id="page-form-unit" class="page hidden">
        <div class="standard-header">
            <div class="back-button" onclick="goBack()">
                <span class="material-icons-outlined">arrow_back</span>
            </div>
            <h2 id="formUnitTitle">Form Satuan</h2>
        </div>
        <div class="form-container"><div style="margin-bottom:20px;"><label style="font-size:13px; font-weight:600; color:var(--green)">Nama Satuan</label><input type="text" id="unitName" class="input-box" style="border:1px solid var(--green)"></div><div style="margin-bottom:20px;"><label style="font-size:13px; font-weight:600; color:var(--gray)">Singkat (Maks 5)</label><input type="text" id="unitShort" class="input-box" maxlength="5"></div></div>
        <div class="bottom-btn-container"><button id="btnActionUnit" class="btn-full" disabled>Simpan</button></div>
    </div>

    <div id="page-tambah-barang-v6" class="page hidden">
        <div class="standard-header">
            <div class="back-button" onclick="goBack()">
                <span class="material-icons-outlined">arrow_back</span>
            </div>
            <h2>Tambah Barang Baru</h2>
        </div>

        <div class="content">
            <div class="input-group">
                <input type="text" class="input-box-v6" id="nama_barang" placeholder=" " autofocus>
                <label class="floating-label" for="nama_barang">Nama Barang</label>
            </div>

            <div class="input-group select-wrapper" onclick="bukaPanelKategori()">
                <input type="text" class="input-box-v6" id="kategori" placeholder=" " readonly>
                <label class="floating-label" for="kategori">Kategori</label>
                <span class="material-icons-outlined chevron">chevron_right</span>
            </div>

            <div class="input-group select-wrapper" onclick="bukaPanelSatuanCompact()">
                <input type="text" class="input-box-v6" id="satuan" placeholder=" " readonly>
                <label class="floating-label" for="satuan">Satuan</label>
                <span class="material-icons-outlined chevron">chevron_right</span>
            </div>

            <div class="tabs" id="dynamic-tabs">
                </div>

<div id="section-offline" class="tab-content-section">
    
    <div class="flex-row" style="position: relative; z-index: 10;">
        
        <div class="input-group w-80">
            <input type="text" class="input-box-v6" id="harga_beli" placeholder=" ">
            <label class="floating-label" for="harga_beli">Harga Beli</label>
        </div>

        <div class="custom-select-container w-20" id="unitDropdownContainer">
            <div class="select-trigger" onclick="toggleUnitDropdown()">
                <span id="selectedUnitText" style="font-weight:700; color:var(--green)"></span>
                <span class="material-icons-outlined" style="font-size:16px;">expand_more</span>
            </div>
            
            <div class="select-options" id="dropdownUnitList"></div>
            
            <input type="hidden" id="satuan_beli_terpilih"> 
        </div>

    </div>

    <div class="input-group">
        <input type="number" class="input-box-v6" id="harga_jual" placeholder=" ">
        <label class="floating-label" for="harga_jual">Harga Warung</label>
    </div>

    <div class="input-group">
        <input type="number" class="input-box-v6" id="harga_eceran" placeholder=" ">
        <label class="floating-label" for="harga_eceran">Harga Eceran</label>
    </div>

    <div id="container-grosir-v6"></div>

    <div class="btn-add-unit green" id="btn-tambah-grosir" onclick="tambahTierGrosirV6()" style="margin-top: 10px;">
        <span class="material-icons-outlined">add_circle</span>
        <span>Tambah Tier Grosir</span>
    </div>

</div>

            <div id="section-online" class="tab-content-section">
                <div class="input-group">
                    <input type="text" class="input-box-v6" id="harga_marketplace" placeholder=" ">
                    <label class="floating-label" for="harga_marketplace">Harga Marketplace</label>
                </div>
                <div class="input-group">
                    <input type="text" class="input-box-v6" id="stok_marketplace" placeholder=" ">
                    <label class="floating-label" for="stok_marketplace">Stok Marketplace</label>
                </div>
            </div>

            <div id="section-tambahan" class="tab-content-section">
                <div class="grid-2">
                    <div class="input-group">
                        <input type="text" class="input-box-v6" id="stok_awal" placeholder=" ">
                        <label class="floating-label" for="stok_awal">Stok Awal</label>
                    </div>
                    <div class="input-group">
                        <input type="text" class="input-box-v6" id="stok_min" placeholder=" ">
                        <label class="floating-label" for="stok_min">Min. Stock</label>
                    </div>
                </div>
                <div class="switch-row">
                    <div class="switch-label">
                        <span class="material-icons-outlined" style="color:var(--green)">notifications_active</span>
                        <span>Peringatan Stok Rendah</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="peringatan_stok">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <div class="bottom-btn-container">
            <button class="btn-full" id="btnSimpan" disabled>
                <span class="material-icons-outlined">save</span>
                Simpan
            </button>
        </div>
    </div>

    <div id="panelKategori" class="pilih-panel">
        <div class="standard-header">
            <div class="back-button" onclick="goBack()">
                <span class="material-icons-outlined">arrow_back</span>
            </div>
            <h2>Pilih Kategori</h2>
        </div>
        <div class="search-area">
            <div class="search-wrap">
                <span class="material-icons-outlined">search</span>
                <input type="text" id="searchKategori" placeholder="Cari kategori..." onkeyup="filterKategori()">
            </div>
        </div>
        <div class="list-container" id="listKategori"></div>
        <div class="bottom-btn-container">
            <button class="btn-full" onclick="bukaFormKategori()">
                <span class="material-icons-outlined">add</span>
                Tambah Kategori Baru
            </button>
        </div>
    </div>

    <div id="panelSatuanCompact" class="pilih-panel">
        <div class="standard-header">
            <div class="back-button" onclick="goBack()">
                <span class="material-icons-outlined">arrow_back</span>
            </div>
            <h2>Atur Satuan</h2>
        </div>

        <div class="panel-content-scrollable">
            <div class="section-title-v6">Satuan Dasar (Terkecil)</div>
            
            <div class="input-group select-wrapper" onclick="bukaPanelPilihSatuan('utama')">
                <input type="text" class="input-box-v6" id="inputSatuanUtama" placeholder=" " readonly>
                <label class="floating-label" for="inputSatuanUtama">Satuan Dasar</label>
                <span class="material-icons-outlined chevron">chevron_right</span>
            </div>
            <div class="info-text">
                <span class="material-icons-outlined">info</span>
                <span>Contoh: Pcs, Gram, Butir (Unit stok terkecil)</span>
            </div>

            <div id="areaKonversi" style="display: none;">
                <hr class="section-divider">
                <div class="section-title-v6">Konversi Satuan Besar</div>

                <div id="listKonversiContainer" class="conversion-list"></div>

                <div class="btn-add-unit green" onclick="bukaPanelPilihSatuan('tambahan')">
                    <span class="material-icons-outlined" style="color:var(--green)">add_circle</span>
                    <span style="color:var(--green)">Tambah Satuan Besar</span>
                </div>
            </div>
        </div>

        <div class="bottom-btn-container">
            <button class="btn-full" id="btnSimpanSatuanCompact" onclick="simpanSatuanCompact()" disabled>
                <span class="material-icons-outlined">save</span>
                Simpan Pengaturan
            </button>
        </div>
    </div>

    <div id="panelSatuan" class="pilih-panel">
        <div class="standard-header">
            <div class="back-button" onclick="goBack()">
                <span class="material-icons-outlined">arrow_back</span>
            </div>
            <h2>Pilih Satuan</h2>
        </div>
        <div class="search-area">
            <div class="search-wrap">
                <span class="material-icons-outlined">search</span>
                <input type="text" id="searchSatuan" placeholder="Cari satuan..." onkeyup="filterSatuan()">
            </div>
        </div>
        <div class="list-container" id="listSatuan"></div>
        <div class="bottom-btn-container">
            <button class="btn-full" onclick="bukaFormSatuan()">
                <span class="material-icons-outlined">add</span>
                Tambah Satuan Baru
            </button>
        </div>
    </div>

    <div id="formKategori" class="form-modal">
        <div class="standard-header">
            <div class="back-button" onclick="goBack()">
                <span class="material-icons-outlined">arrow_back</span>
            </div>
            <h2>Tambah Kategori Baru</h2>
        </div>
        <div class="form-content">
            <div>
                <label class="form-label">Nama Kategori</label>
                <input type="text" id="namaKategoriBaru" class="form-input" placeholder="Contoh: Makanan/Minuman" style="border:1px solid var(--green)">
            </div>
            <div style="color:var(--gray); font-size:12px; margin-top:15px;">
                <span class="material-icons-outlined" style="font-size:16px; vertical-align:middle;">info</span>
                Kategori akan langsung tersedia untuk dipilih
            </div>
        </div>
        <div class="bottom-btn-container">
            <button id="btnSimpanKategori" class="btn-full" onclick="simpanKategoriBaru()" disabled>
                <span class="material-icons-outlined">save</span>
                Simpan Kategori
            </button>
        </div>
    </div>

    <div id="formSatuan" class="form-modal">
        <div class="standard-header">
            <div class="back-button" onclick="goBack()">
                <span class="material-icons-outlined">arrow_back</span>
            </div>
            <h2>Tambah Satuan Baru</h2>
        </div>
        <div class="form-content">
            <div>
                <label class="form-label">Nama Satuan</label>
                <input type="text" id="namaSatuanBaru" class="form-input" placeholder="Contoh: Gram/Kilogram" style="border:1px solid var(--green)">
            </div>
            <div>
                <label class="form-label">Kode Satuan (Maks 5 karakter)</label>
                <input type="text" id="kodeSatuanBaru" class="form-input" placeholder="100GR" maxlength="5" oninput="this.value = this.value.toUpperCase()">
            </div>
            <div style="color:var(--gray); font-size:12px; margin-top:15px;">
                <span class="material-icons-outlined" style="font-size:16px; vertical-align:middle;">info</span>
                Satuan akan langsung tersedia untuk dipilih
            </div>
        </div>
        <div class="bottom-btn-container">
            <button id="btnSimpanSatuan" class="btn-full" onclick="simpanSatuanBaru()" disabled>
                <span class="material-icons-outlined">save</span>
                Simpan Satuan
            </button>
        </div>
    </div>
<div id="modalDiscardTambahBarang" class="modal-confirm-overlay-tb">
    <div class="modal-confirm-card-tb">
        <div class="icon-circle-tb">
            <span class="material-icons-outlined" style="font-size: 28px;">question_mark</span>
        </div>
        <div class="modal-confirm-title-tb">Buang Perubahan?</div>
        <div class="modal-confirm-text-tb">
            Anda memiliki perubahan data barang yang belum disimpan. Apakah Anda yakin ingin menghapusnya?
        </div>
        
        <button class="btn-continue-tb" onclick="tutupModalDiscard()">Lanjutkan Mengedit</button>
        <button class="btn-discard-tb" onclick="konfirmasiBuang()">Kembali</button>
    </div>
</div>

<script type="module">
    // Import database
    import { db, ref, onValue, push, update, remove } from "./firebase-config.js";
    import './pengaturan-inventaris.js';
    import './tambah-barang-inventaris.js';

    // ============ 1. NAVIGASI & UI UTAMA ============
    let pageHistory = ['page-inventaris'];
    let panelStack = [];
    
    // Override goBack untuk menangani Panel, Modal, dan Navigasi Halaman
    window.goBack = function() {
        // A. Cek Panel Popup (Prioritas Utama: Kategori/Satuan)
        // Jika ada panel terbuka, tutup panelnya saja. Jangan cek form kotor dulu.
        if (panelStack.length > 0) {
            const panelId = panelStack.pop();
            const panelEl = document.getElementById(panelId);
            if (panelEl) panelEl.classList.remove('show');
            
            // Jika tidak ada panel lain yang buka, hilangkan layar gelap
            if (panelStack.length === 0) {
                const overlay = document.getElementById('modalOverlay');
                if(overlay) overlay.classList.remove('show');
            }
            return;
        }

        // B. Cek Apakah Form Tambah Barang "Kotor" (Ada data belum disimpan)
        const pageTambah = document.getElementById('page-tambah-barang-v6');
        const isTambahPageActive = pageTambah && !pageTambah.classList.contains('hidden');
        
        if (isTambahPageActive && isFormDirty) {
            // Tampilkan Modal Konfirmasi
            const modal = document.getElementById('modalDiscardTambahBarang');
            if(modal) modal.style.display = 'flex';
            return; // STOP! Jangan navigasi mundur.
        }

        // C. Navigasi Mundur Normal (Halaman)
        if (pageHistory.length > 1) {
            pageHistory.pop(); 
            const prevPage = pageHistory[pageHistory.length - 1]; 
            
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            const prevPageEl = document.getElementById(prevPage);
            if(prevPageEl) prevPageEl.classList.remove('hidden');
            
            // Komunikasi ke Parent (index.html)
            if (prevPage === 'page-inventaris') window.parent.postMessage('show-parent-ui', '*');
            else window.parent.postMessage('hide-parent-ui', '*');
        } else {
            // Jika history habis, minta parent tutup aplikasi/iframe
            window.parent.postMessage('go-back', '*');
        }
    };

    window.goToPage = function(pageId) {
        closeAllPanels();
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        
        const page = document.getElementById(pageId);
        if (page) {
            page.classList.remove('hidden');
            pageHistory.push(pageId);
            
            if (pageId === 'page-inventaris') window.parent.postMessage('show-parent-ui', '*');
            else window.parent.postMessage('hide-parent-ui', '*');
        }
    };

    window.openPanel = function(panelId) {
        panelStack.push(panelId);
        document.getElementById(panelId).classList.add('show');
        document.getElementById('modalOverlay').classList.add('show');
    };

    function closeAllPanels() {
        panelStack.forEach(panelId => {
            const el = document.getElementById(panelId);
            if(el) el.classList.remove('show');
        });
        panelStack = [];
        const overlay = document.getElementById('modalOverlay');
        if(overlay) overlay.classList.remove('show');
    }

    // ============ 2. LOGIKA RESET & DIRTY CHECK (ANTI-CRASH) ============
    let isFormDirty = false;

    // Fungsi Hook Aman: Mendeteksi perubahan oleh script (Kategori/Satuan)
    function hookProgrammaticChange(inputId) {
        const el = document.getElementById(inputId);
        // Cek ketat: jika elemen tidak ada atau sudah di-hook, berhenti.
        if (!el || el.dataset.hooked === "true") return; 

        const descriptor = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value');

        Object.defineProperty(el, 'value', {
            get: function() { return descriptor.get.call(this); },
            set: function(val) {
                const oldVal = descriptor.get.call(this);
                descriptor.set.call(this, val); // Jalankan set asli
                
                // Hanya tandai kotor jika nilainya benar-benar berubah
                // DAN bukan saat proses reset (kita handle flag reset manual nanti)
                if (oldVal !== val) {
                    isFormDirty = true;
                }
            },
            configurable: true
        });
        
        el.dataset.hooked = "true";
    }

    function initDirtyCheck() {
        const formContainer = document.getElementById('page-tambah-barang-v6');
        if(!formContainer) return;

        // 1. Event Delegation (Lebih Ringan & Stabil)
        // Menangkap ketikan di input apa saja di dalam form
        formContainer.addEventListener('input', (e) => {
            if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') isFormDirty = true;
        });
        formContainer.addEventListener('change', (e) => {
            if(e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') isFormDirty = true;
        });

        // 2. Pasang Hook Khusus untuk Input ReadOnly (Kategori & Satuan)
        hookProgrammaticChange('kategori');
        hookProgrammaticChange('satuan');
    }

    // Fungsi RESET FORM (VERSI AMAN / SAFE MODE)
    window.resetFormV6 = function() {
        try {
            // A. Reset Input Text & Number
            document.querySelectorAll('#page-tambah-barang-v6 input').forEach(input => {
                if(input.type !== 'checkbox' && input.type !== 'radio') input.value = '';
            });

            // B. Reset Elemen Spesifik (Dengan Pengecekan Eksistensi)
            const switchStok = document.getElementById('peringatan_stok');
            if(switchStok) switchStok.checked = false;
            
            const displaySatuan = document.getElementById('selectedUnitText');
            if(displaySatuan) displaySatuan.innerText = "";
            
            const hiddenSatuan = document.getElementById('satuan_beli_terpilih');
            if(hiddenSatuan) hiddenSatuan.value = "";

            const btnSimpan = document.getElementById('btnSimpan');
            if(btnSimpan) btnSimpan.disabled = true;

            // C. Reset AppState Global (Logic Satuan)
            if(typeof window.appState !== 'undefined') {
                window.appState = { satuanUtama: null, satuanTambahan: [] };
            }
        } catch (e) {
            console.warn("Reset Form Warning:", e);
        } finally {
            // D. PASTIKAN Status Dirty Reset ke False (Apapun yang terjadi)
            isFormDirty = false;
        }
    };

    // Override Buka Tambah Barang (Entry Point)
    window.bukaTambahBarang = function() {
        // 1. Reset dulu agar bersih dari sesi sebelumnya
        window.resetFormV6(); 
        
        // 2. Buka Halaman
        window.goToPage('page-tambah-barang-v6');
        
        // 3. Setup UI (Tabs)
        if(window.setupTabs) window.setupTabs(); 
        
        // 4. Inisialisasi Detektor (Aman dipanggil berkali-kali karena ada cek di dalamnya)
        initDirtyCheck();
        
        // 5. Paksa Flag Bersih lagi (untuk memastikan hook tidak menandai kotor saat setup)
        isFormDirty = false;
    };

    // Fungsi Modal Konfirmasi
    window.tutupModalDiscard = function() {
        const modal = document.getElementById('modalDiscardTambahBarang');
        if(modal) modal.style.display = 'none';
    };

    window.konfirmasiBuang = function() {
        const modal = document.getElementById('modalDiscardTambahBarang');
        if(modal) modal.style.display = 'none';
        
        window.resetFormV6(); // Bersihkan data
        
        // Mundur Manual (Bypass dirty check karena sudah dibersihkan)
        if (pageHistory.length > 1) {
            pageHistory.pop();
            const prevPage = pageHistory[pageHistory.length - 1];
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            const prevEl = document.getElementById(prevPage);
            if(prevEl) prevEl.classList.remove('hidden');
            
            if (prevPage === 'page-inventaris') window.parent.postMessage('show-parent-ui', '*');
            else window.parent.postMessage('hide-parent-ui', '*');
        } else {
            window.parent.postMessage('go-back', '*');
        }
    };

    // ============ 3. LOGIKA DROPDOWN SATUAN ============
    window.toggleUnitDropdown = function() {
        const list = document.getElementById('dropdownUnitList');
        if(!list) return;
        window.renderUnitFromParentField(); 
        list.classList.toggle('open');
    };

    window.renderUnitFromParentField = function() {
        const list = document.getElementById('dropdownUnitList');
        const display = document.getElementById('selectedUnitText');
        const hiddenInput = document.getElementById('satuan_beli_terpilih');
        const parentInput = document.getElementById('satuan');
        
        if(!list || !display || !hiddenInput || !parentInput) return;

        const parentValue = parentInput.value; 
        const dbSatuan = window.satuanData || [];

        list.innerHTML = ''; 
        let parsedNames = [];

        if (parentValue) {
            const match = parentValue.match(/^(.*?)\s*(?:\((.*?)\))?$/);
            if (match) {
                if(match[1]) parsedNames.push(match[1].trim());
                if (match[2]) parsedNames.push(...match[2].split(',').map(s => s.trim()));
            } else {
                parsedNames.push(parentValue);
            }
        }

        if (parsedNames.length === 0) {
            const div = document.createElement('div');
            div.className = 'select-option';
            div.innerText = "(Isi Satuan dulu)";
            div.style.color = '#ccc';
            div.style.pointerEvents = 'none';
            list.appendChild(div);
        } else {
            parsedNames.forEach((namaPanjang) => {
                const dataFound = dbSatuan.find(s => s.nama.toLowerCase() === namaPanjang.toLowerCase());
                const kodeResmi = dataFound ? dataFound.kode : namaPanjang; 

                const div = document.createElement('div');
                div.className = 'select-option';
                div.innerText = namaPanjang; 
                div.onclick = () => {
                    display.innerText = kodeResmi; 
                    hiddenInput.value = namaPanjang; 
                    
                    // Tandai Manual sebagai Kotor
                    isFormDirty = true; 

                    const lblJual = document.querySelector('label[for="harga_jual"]');
                    if(lblJual) lblJual.innerText = `Harga Warung (${namaPanjang})`;

                    const lblEceran = document.querySelector('label[for="harga_eceran"]');
                    if(lblEceran) lblEceran.innerText = `Harga Eceran (${namaPanjang})`;
                    
                    list.classList.remove('open');
                };
                list.appendChild(div);
            });
        }
    };
    
    document.addEventListener('click', function(e) {
        const container = document.getElementById('unitDropdownContainer');
        const list = document.getElementById('dropdownUnitList');
        if (container && list && !container.contains(e.target)) {
            list.classList.remove('open');
        }
    });

    // ============ 4. SETUP AWAL ============
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.back-button').forEach(btn => {
            btn.onclick = function(e) { e.preventDefault(); window.goBack(); };
        });
        
        const overlay = document.getElementById('modalOverlay');
        if(overlay) {
            overlay.onclick = function() {
                if (panelStack.length > 0) window.goBack();
            };
        }

        window.goToPage('page-inventaris');
        initFirebase();
    });

    // ============ 5. NAVIGASI LAINNYA ============
    window.showPage = window.goToPage;
    window.bukaPengaturan = function() { window.goToPage('page-pengaturan'); };
    window.tutupPengaturan = function() { window.goToPage('page-inventaris'); };
    window.tutupTambahBarang = function() { window.goToPage('page-inventaris'); };
    
    window.bukaPanelKategori = function() { window.openPanel('panelKategori'); window.filterKategori(); };
    window.tutupPanelKategori = function() { window.goBack(); };
    window.tutupPanelSatuanCompact = function() { window.goBack(); };
    window.tutupPanelSatuan = function() { window.goBack(); };
    window.bukaFormKategori = function() { window.openPanel('formKategori'); };
    window.tutupFormKategori = function() { window.goBack(); };
    window.bukaFormSatuan = function() { window.openPanel('formSatuan'); };
    window.tutupFormSatuan = function() { window.goBack(); };

    // ============ 6. FIREBASE & DATA ============
    window.kategoriData = [];
    window.satuanData = [];
    let cache = { products: {}, cat: {}, mkt: {}, sup: {} };
    
    function initFirebase() {
        onValue(ref(db, 'products'), (snap) => {
            cache.products = snap.val() || {}; 
            renderProductList();
            refreshList(cache.cat, 'category-list-display', 'kategori', 'cat'); 
            refreshList(cache.mkt, 'market-list-display', 'marketplace', 'mkt'); 
            refreshList(cache.sup, 'supplier-list-display', 'suplayer', 'sup');
        });
        onValue(ref(db, 'categories'), (snap) => { 
            cache.cat = snap.val() || {}; 
            refreshList(cache.cat, 'category-list-display', 'kategori', 'cat'); 
            loadKategoriV6(snap);
        });
        onValue(ref(db, 'marketplaces'), (snap) => { 
            cache.mkt = snap.val() || {}; 
            refreshList(cache.mkt, 'market-list-display', 'marketplace', 'mkt'); 
        });
        onValue(ref(db, 'suppliers'), (snap) => { 
            cache.sup = snap.val() || {}; 
            refreshList(cache.sup, 'supplier-list-display', 'suplayer', 'sup'); 
        });
        onValue(ref(db, 'units'), (snap) => {
            renderUnitList(snap);
            loadSatuanV6(snap);
        });
    }

    // --- RENDER FUNCTIONS ---
    function renderProductList() {
        const inv = document.getElementById('inventory-list'); 
        if(!inv) return;
        inv.innerHTML = "";
        for (let id in cache.products) {
            const p = cache.products[id];
            inv.innerHTML += `
                <div class="card">
                    <div class="initial">${p.nama.substring(0,2).toUpperCase()}</div>
                    <div class="info">
                        <div class="name"><b>${p.nama}</b></div>
                        <div class="price-row">
                            <div>Jual<strong>Rp ${Number(p.hargaJual).toLocaleString('id-ID')}</strong></div>
                            <div>Beli<strong>Rp ${Number(p.hargaBeli).toLocaleString('id-ID')}</strong></div>
                        </div>
                    </div>
                    <div class="status">
                        <span class="badge">${p.kategori}</span>
                        <div style="font-weight:800; margin-top:5px;">${p.stok} ${p.satuan || 'PCS'}</div>
                    </div>
                </div>`;
        }
    }

    function renderUnitList(snap) {
        const el = document.getElementById('unit-list-display'); 
        if(!el) return;
        el.innerHTML = ""; 
        const data = snap.val() || {};
        for (let id in data) {
            const item = document.createElement('div'); 
            item.className = 'common-list-item';
            item.innerHTML = `
                <div class="unit-info">
                    <b>${data[id].nama}</b>
                    <div style="color:var(--gray);font-size:12px">${data[id].kode}</div>
                </div>
                <div class="unit-actions">
                    <span class="material-icons-outlined edit-u" style="cursor:pointer; margin-right:15px">edit</span>
                    <span class="material-icons-outlined del-u" style="color:var(--red); cursor:pointer">delete</span>
                </div>`;
            item.querySelector('.edit-u').onclick = () => window.openEditUnit(id, data[id].nama, data[id].kode);
            item.querySelector('.del-u').onclick = () => { if(confirm('Hapus Satuan?')) remove(ref(db, `units/${id}`)); }; 
            el.appendChild(item);
        }
    }
    
    window.updateOnlineStatus = (c) => { 
        const el = document.getElementById('status-icon');
        if(el) el.style.color = c.checked ? "var(--green)" : "var(--gray)"; 
    };
    
    window.adjustDecimal = (v) => { 
        const i = document.getElementById('decimal-count'); 
        if(!i) return;
        let r = parseInt(i.value) + v; 
        if (r >= 0 && r <= 4) i.value = r; 
    };
    
    const refreshList = (data, container, key, type) => {
        const el = document.getElementById(container); 
        if(!el) return;
        el.innerHTML = "";
        for (let id in data) {
            let count = 0; 
            for(let pId in cache.products) { if(cache.products[pId][key] === data[id].nama) count++; }
            const item = document.createElement('div'); 
            item.className = 'common-list-item';
            item.innerHTML = `
                <div class="unit-info"><b>${data[id].nama}</b><div style="color:var(--gray);font-size:12px">${count} Barang</div></div>
                <div class="unit-actions">
                    <span class="material-icons-outlined edit-ic" style="cursor:pointer; margin-right:15px">edit</span>
                    <span class="material-icons-outlined del-ic" style="color:var(--red); cursor:pointer">delete</span>
                </div>`;
            item.querySelector('.edit-ic').onclick = () => window.openEdit(type, id, data[id].nama);
            item.querySelector('.del-ic').onclick = () => { if(confirm('Hapus?')) remove(ref(db, `${type === 'cat' ? 'categories' : type === 'mkt' ? 'marketplaces' : 'suppliers'}/${id}`)); };
            el.appendChild(item);
        }
    };

    function loadKategoriV6(snapCategories) {
        const categories = snapCategories.val() || {};
        const products = cache.products || {};
        const productCount = {};
        for (let pid in products) { const p = products[pid]; const kategori = p.kategori?.trim() || "Umum"; productCount[kategori] = (productCount[kategori] || 0) + 1; }
        window.kategoriData = [];
        for (let id in categories) { const cat = categories[id]; window.kategoriData.push({ id: id, nama: cat.nama, count: productCount[cat.nama] || 0 }); }
        if (!window.kategoriData.find(c => c.nama === "Umum")) { window.kategoriData.push({ id: 'umum', nama: "Umum", count: productCount["Umum"] || 0 }); }
        window.kategoriData.sort((a, b) => a.nama.localeCompare(b.nama));
        if(window.filterKategori) window.filterKategori();
    }

    function loadSatuanV6(snapUnits) {
        const units = snapUnits.val() || {};
        const products = cache.products || {};
        const productCount = {};
        for (let pid in products) { const p = products[pid]; const satuan = p.satuan?.trim(); if (satuan) productCount[satuan] = (productCount[satuan] || 0) + 1; }
        window.satuanData = [];
        for (let id in units) { const unit = units[id]; window.satuanData.push({ id: id, nama: unit.nama, kode: unit.kode, count: productCount[unit.kode] || 0 }); }
        if (!window.satuanData.find(u => u.kode === "PCS")) { window.satuanData.push({ id: 'default', nama: "Pieces", kode: "PCS", count: 0 }); }
        window.satuanData.sort((a, b) => a.nama.localeCompare(b.nama));
        if(window.filterSatuan) window.filterSatuan();
    }

window.tambahTierGrosirV6 = function() {
    const container = document.getElementById('container-grosir-v6');
    const displayUnit = document.getElementById('selectedUnitText').innerText || ""; 
    const tierId = Date.now(); 

    const row = document.createElement('div');
    row.className = 'flex-row'; 
    row.id = `tier-${tierId}`;
    row.style.marginTop = '10px';

    row.innerHTML = `
        <div class="input-group w-30" style="position: relative;">
            <input type="number" class="input-box-v6" placeholder=" ">
            <label class="floating-label">Min Qty</label>
            <span class="unit-indicator" style="opacity:1">${displayUnit}</span>
        </div>
        <div class="input-group w-70" style="position: relative;">
            <input type="number" class="input-box-v6" placeholder=" " style="padding-right: 40px;">
            <label class="floating-label">Harga Grosir</label>
            
            <span class="material-icons-outlined" 
                  onclick="document.getElementById('tier-${tierId}').remove()" 
                  style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
                         color: var(--red); cursor: pointer; font-size: 20px; z-index: 5;">
                delete
            </span>
        </div>
    `;
    container.appendChild(row);
};

function initPriceMirroring() {
    const inputWarung = document.getElementById('harga_jual'); // Harga Warung
    const inputEceran = document.getElementById('harga_eceran'); // Harga Eceran

    if (inputWarung && inputEceran) {
        inputWarung.addEventListener('input', () => {
            // Salin nilai dari Warung ke Eceran secara otomatis
            inputEceran.value = inputWarung.value;

            // Trigger event input pada Eceran agar label floating-nya sadar ada isi
            inputEceran.dispatchEvent(new Event('input'));
            
            // Tandai form sebagai kotor/berubah
            isFormDirty = true;
        });
    }
}

// Panggil fungsi ini saat halaman dimuat
document.addEventListener('DOMContentLoaded', initPriceMirroring);
</script>
</body>
</html>